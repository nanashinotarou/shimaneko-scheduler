<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã—ã¾ã­ã“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ Pro</title>

    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Removed Tesseract.js for Gemini API Integration -->

    <style>
        :root {
            --color-bg: #FFFAF0;
            /* ãƒ•ãƒ­ãƒ¼ãƒ©ãƒ«ãƒ›ãƒ¯ã‚¤ãƒˆ */
            --color-text: #8D6E63;
            /* ãƒ–ãƒ©ã‚¦ãƒ³ */
            --color-accent: #F4A460;
            /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            --color-accent-hover: #E09050;
            --color-white: #FFFFFF;
            --color-border: #D7CCC8;
            --radius-main: 16px;
            --radius-sm: 8px;
            --shadow-card: 0 4px 12px rgba(141, 110, 99, 0.08);

            /* Default Member Colors */
            --col-sasami: #F48FB1;
            --col-kombu: #A5D6A7;
            --col-tsuna: #90CAF9;
            --col-task: #FF7043;
            /* Task Red */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
            padding-bottom: 80px;
        }

        h1,
        h2,
        h3,
        h4 {
            font-weight: 700;
            color: var(--color-text);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Card Style */
        .card {
            background: var(--color-white);
            border-radius: var(--radius-main);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--color-bg);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background-color: var(--color-text);
            color: var(--color-white);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:hover {
            background-color: var(--color-accent);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: transparent;
            border: 2px solid var(--color-text);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }

        /* Forms */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
        }

        input[type="text"],
        textarea,
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--color-border);
            background-color: var(--color-bg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--color-text);
            outline: none;
            transition: border-color 0.2s;
        }

        textarea {
            height: 120px;
            resize: vertical;
            margin-bottom: 16px;
        }

        input[type="text"]:focus,
        textarea:focus,
        input[type="date"]:focus {
            border-color: var(--color-accent);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-main);
            padding: 24px;
            text-align: center;
            color: var(--color-text);
            background-color: var(--color-bg);
            margin-bottom: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            background-color: #FFF3E0;
            border-color: var(--color-accent);
        }

        /* Member Config Items */
        .member-setting-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-bg);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* Preview Table */
        .preview-list {
            list-style: none;
            margin-top: 16px;
        }

        .preview-item {
            background: var(--color-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .preview-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-member {
            font-size: 0.8rem;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .preview-delete {
            color: #d32f2f;
            cursor: pointer;
            font-size: 1.2rem;
            background: none;
            border: none;
            padding: 8px;
        }

        /* Calendar View */
        .calendar-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .date-row {
            background: var(--color-white);
            border-radius: var(--radius-sm);
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 12px;
        }

        .date-header {
            text-align: center;
            border-right: 2px solid var(--color-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .date-num {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .date-day {
            font-size: 0.8rem;
            color: #888;
        }

        .shift-bars {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .shift-bar {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        .task-bar {
            border-left: 4px solid var(--col-task);
            background: #FFEBEE;
            color: #D84315;
            font-weight: bold;
        }

        .shift-name {
            font-weight: bold;
            margin-right: 8px;
        }

        .shift-time {
            font-size: 0.75rem;
        }

        /* Matching View */
        .matching-item {
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            color: #2E7D32;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 250, 240, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .tab-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border-radius: 20px;
            border: none;
            background: #EEE;
            cursor: pointer;
            font-weight: bold;
            color: #888;
        }

        .tab-btn.active {
            background: var(--color-accent);
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1 style="cursor: pointer;" onclick="showHome()">ğŸˆ ã—ã¾ã­ã“äºˆå®šè¡¨ Pro</h1>
        </header>

        <!-- Home/Calendar Section -->
        <section id="home-section">
            <div class="card" style="padding: 16px;">
                <div class="tab-group">
                    <button class="tab-btn active" id="tab-calendar" onclick="switchTab('calendar')">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
                    <button class="tab-btn" id="tab-matching" onclick="switchTab('matching')">ğŸ¤ ãƒãƒƒãƒãƒ³ã‚°</button>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm" onclick="toggleSection('import')">+ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleSection('settings')">âš™ï¸ è¨­å®š</button>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="clearData()">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div id="calendar-view">
                <div id="calendar-container" class="calendar-list"></div>
            </div>

            <div id="matching-view" class="hidden">
                <div class="card">
                    <h3>ğŸˆ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ¨å¥¨æ—¥æ™‚</h3>
                    <p style="font-size:0.9rem; color:#666; margin-bottom:12px;">å…¨å“¡ãŒã€Œä¼‘ã¿ã€ã§ã¯ãªãã€ã‚·ãƒ•ãƒˆãŒå…¥ã£ã¦ã„ã‚‹å…±é€šã®æ™‚é–“å¸¯ã§ã™ã€‚</p>
                    <div id="matching-list"></div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
                <button class="btn btn-sm btn-secondary" onclick="saveSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
            </div>

            <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px dashed var(--color-border);">
                <div class="member-header">
                    <span>ğŸ¤– Gemini API ã‚­ãƒ¼</span>
                </div>
                <label style="font-size:0.8rem;">ç”»åƒã®é«˜ç²¾åº¦è§£æã«ä½¿ç”¨ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ãƒ»å¤–éƒ¨é€ä¿¡ãªã—ï¼‰</label>
                <input type="password" id="setting-gemini-key" placeholder="AIzaSy... (APIã‚­ãƒ¼ã‚’å…¥åŠ›)">
                <p style="font-size:0.75rem; color:#888; margin-top:4px;">Google AI Studioã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <p style="font-size:0.9rem; margin-bottom:16px;">
                ã‚·ãƒ•ãƒˆè¡¨ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹åå‰ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
                â€»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šã§ãã¾ã™ã€‚
            </p>

            <div id="settings-list"></div>
        </section>

        <!-- Import Section -->
        <section id="import-section" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                <button class="btn btn-sm btn-secondary" onclick="showHome()">é–‰ã˜ã‚‹</button>
            </div>

            <div class="drop-zone" id="drop-zone">
                <p>ğŸ“· ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—<br>(ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ)<br><span
                        style="font-size: 0.8rem; color: #aaa;">OCRã§ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Šã¾ã™</span></p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <p style="margin-bottom: 8px; font-size: 0.9rem;">ãƒ†ã‚­ã‚¹ãƒˆ (ã‚·ãƒ•ãƒˆè¡¨ ã¾ãŸã¯ Notionã‚¿ã‚¹ã‚¯)</p>
            <textarea id="raw-text-input" placeholder="ä¾‹: 2/20 ç”°ä¸­ 10-19&#10;ä¾‹: 2/25 LPãƒ‡ã‚¶ã‚¤ãƒ³æå‡º"></textarea>
            <button id="btn-analyze" class="btn">è§£æã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </section>

        <!-- Preview Section -->
        <section id="preview-section" class="card hidden">
            <h2>è§£æçµæœã®ç¢ºèª</h2>
            <p style="margin-bottom: 16px; font-size: 0.9rem;">
                èª­ã¿å–ã‚ŠãƒŸã‚¹ãŒã‚ã‚Œã°æ—¥ä»˜ã‚„å†…å®¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            </p>

            <div id="preview-list" class="preview-list"></div>

            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button id="btn-cancel" class="btn btn-secondary" onclick="toggleSection('import')">ã‚„ã‚Šç›´ã—</button>
                <button id="btn-save" class="btn" onclick="saveData()">ã“ã‚Œã§ä¿å­˜</button>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div style="font-size: 2rem;">ğŸˆ</div>
            <p id="loading-text" style="font-weight: bold; margin-top: 16px;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

    </div>

    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line) {
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + msg + "\\nè¡Œ: " + line);
            return false;
        };

        // Config & Data
        const DEFAULT_MEMBERS = [
            { id: "sasami", name: "ã‚µã‚µãƒŸ", color: "#F48FB1", keywords: "ã‚µã‚µãƒŸ,ä½ã€…æœ¨,Sasaki" },
            { id: "kombu", name: "ã‚³ãƒ³ãƒ–", color: "#A5D6A7", keywords: "ã‚³ãƒ³ãƒ–,æ˜†å¸ƒ,ãƒœãƒ–,ç”°ä¸­" },
            { id: "tsuna", name: "ãƒ„ãƒŠ", color: "#90CAF9", keywords: "ãƒ„ãƒŠ,ç¶±,Tsuna,ä½è—¤" }
        ];

        const STORAGE_KEY_DATA = "shimaneko_scheduler_data_v3";
        const STORAGE_KEY_CONFIG = "shimaneko_scheduler_config_v1";
        const STORAGE_KEY_API = "shimaneko_scheduler_gemini_key";

        let memberConfig = [];
        let geminiApiKey = "";
        let appData = { shifts: [] };
        let tempParsedData = [];

        // Valid DOM Elements check
        const elHomeSection = document.getElementById('home-section');
        const elSettingsSection = document.getElementById('settings-section');
        const elImportSection = document.getElementById('import-section');
        const elPreviewSection = document.getElementById('preview-section');

        // View DOMs
        const elCalendarView = document.getElementById('calendar-view');
        const elMatchingView = document.getElementById('matching-view');
        const elCalendarContainer = document.getElementById('calendar-container');
        const elMatchingList = document.getElementById('matching-list');

        const elInput = document.getElementById('raw-text-input');
        const elPreviewList = document.getElementById('preview-list');

        const elLoading = document.getElementById('loading-overlay');
        const elLoadingText = document.getElementById('loading-text');
        const elDropZone = document.getElementById('drop-zone');
        const elFileInput = document.getElementById('file-input');

        // Init
        loadConfig();
        loadData();
        renderCalendar();
        renderMatching();

        // Events
        document.getElementById('btn-analyze').addEventListener('click', analyzeText);

        elDropZone.addEventListener('click', () => elFileInput.click());

        elDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elDropZone.classList.add('dragover');
        });

        elDropZone.addEventListener('dragleave', () => {
            elDropZone.classList.remove('dragover');
        });

        elDropZone.addEventListener('drop', handleImageDrop);
        elFileInput.addEventListener('change', (e) => handleImageFile(e.target.files[0]));

        // Navigation & Tabs
        function toggleSection(mode) {
            elHomeSection.classList.add('hidden');
            elSettingsSection.classList.add('hidden');
            elImportSection.classList.add('hidden');
            elPreviewSection.classList.add('hidden');
            elLoading.classList.add('hidden');

            if (mode === 'home') {
                elHomeSection.classList.remove('hidden');
                renderCalendar();
                renderMatching();
            } else if (mode === 'settings') {
                renderSettings();
                elSettingsSection.classList.remove('hidden');
            } else if (mode === 'import') {
                elImportSection.classList.remove('hidden');
            } else if (mode === 'preview') {
                elPreviewSection.classList.remove('hidden');
            }
        }

        window.switchTab = (tab) => {
            document.getElementById('tab-calendar').classList.remove('active');
            document.getElementById('tab-matching').classList.remove('active');

            elCalendarView.classList.add('hidden');
            elMatchingView.classList.add('hidden');

            if (tab === 'calendar') {
                document.getElementById('tab-calendar').classList.id = 'active'; // Class handling fix
                document.getElementById('tab-calendar').classList.add('active');
                elCalendarView.classList.remove('hidden');
            } else {
                document.getElementById('tab-matching').classList.add('active');
                elMatchingView.classList.remove('hidden');
                renderMatching();
            }
        };

        window.toggleSection = toggleSection;
        window.showHome = () => toggleSection('home');
        window.clearData = clearData;
        window.saveSettings = saveSettings;
        window.saveData = saveData;

        // --- Settings Logic ---
        function loadConfig() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_CONFIG);
                if (raw) {
                    memberConfig = JSON.parse(raw);
                    // Remove mito from existing local storage config
                    memberConfig = memberConfig.filter(m => m.id !== "mito");
                } else {
                    memberConfig = JSON.parse(JSON.stringify(DEFAULT_MEMBERS));
                }

                geminiApiKey = localStorage.getItem(STORAGE_KEY_API) || "";
            } catch (e) {
                console.error("Config load error", e);
                memberConfig = JSON.parse(JSON.stringify(DEFAULT_MEMBERS));
            }
        }

        function renderSettings() {
            const list = document.getElementById('settings-list');
            list.innerHTML = '';

            document.getElementById('setting-gemini-key').value = geminiApiKey;

            memberConfig.forEach((m, idx) => {
                const div = document.createElement('div');
                div.className = 'member-setting-item';
                div.innerHTML = `
                <div class="member-header">
                    <span class="color-dot" style="background:${m.color}"></span>
                    <span>${m.name}</span>
                </div>
                <label style="font-size:0.8rem;">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                <input type="text" id="setting-keywords-${idx}" value="${m.keywords}">
            `;
                list.appendChild(div);
            });
        }

        function saveSettings() {
            memberConfig.forEach((m, idx) => {
                const el = document.getElementById(`setting-keywords-${idx}`);
                if (el) m.keywords = el.value;
            });
            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(memberConfig));

            geminiApiKey = document.getElementById('setting-gemini-key').value.trim();
            localStorage.setItem(STORAGE_KEY_API, geminiApiKey);

            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            toggleSection('home');
        }

        // --- Image to Base64 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data URL prefix
                reader.onerror = error => reject(error);
            });
        }

        // --- OCR Logic ---
        async function handleImageDrop(e) {
            e.preventDefault();
            elDropZone.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleImageFile(e.dataTransfer.files[0]);
            }
        }

        async function handleImageFile(file) {
            if (!file) return;

            if (!geminiApiKey) {
                alert("è¨­å®šç”»é¢ã‹ã‚‰Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ç”»åƒè§£æã«ã¯æœ¬ç‰©ã®AIã‚’åˆ©ç”¨ã—ã¾ã™ã€‚");
                toggleSection('settings');
                return;
            }

            elLoading.classList.remove('hidden');
            elLoadingText.innerText = "Gemini AIãŒç”»åƒã‚’è§£æä¸­...\\n(ã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)";

            try {
                const base64Image = await fileToBase64(file);

                // Construct prompt dynamically with member configurations
                const memberNamesStr = memberConfig.map(m => `ã€Œ${m.name}ã€ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${m.keywords}ï¼‰`).join("ã€");

                const promptText = `
ä»¥ä¸‹ã®ç”»åƒã¯ã‚¹ã‚¿ãƒƒãƒ•ã®å‹¤å‹™ã‚·ãƒ•ãƒˆè¡¨ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ï¼‰ã§ã™ã€‚
ã“ã®ä¸­ã‹ã‚‰ã€${memberNamesStr} ã®ã‚·ãƒ•ãƒˆæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã€ä»¥ä¸‹ã®JSONé…åˆ—ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ (\`\`\`json) ã¯å«ã‚ã¡ã‚ƒã ã‚ã§ã™ã€‚ç›´æ¥JSONãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

ã€è¶…é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
1. å¯¾è±¡åˆ—ã®ç‰¹å®š: è¡¨ã®1è¡Œç›®ï¼ˆã¾ãŸã¯ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‰ã«ã‚ã‚‹åå‰ã‚’ç¢ºèªã—ã€æä¾›ã•ã‚ŒãŸã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã«åˆè‡´ã™ã‚‹åå‰ã®åˆ—ã ã‘ã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚åˆè‡´ã—ãªã„åå‰ã®åˆ—ã¯ã€çµ¶å¯¾ã«èª­ã¿å–ã‚‰ãªã„ã§ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šåˆ¥ã®äººã®åˆ—ã«ã‚ã‚‹æ–‡å­—ã‚’èª¤æ¤œçŸ¥ã—ãªã„ã“ã¨ï¼‰
2. æ—¥ä»˜ã¨å€¤ã®äº¤å·®: æ—¥ä»˜ã”ã¨ã®è¡Œã¨ã€ç‰¹å®šã—ãŸå¯¾è±¡åˆ—ãŒäº¤å·®ã™ã‚‹ã‚»ãƒ«ã®å€¤ã‚’æ­£ç¢ºã«èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
3. å€¤ã®æŠ½å‡ºãƒ«ãƒ¼ãƒ«:
   - "10-19", "4.5", "11â†’", "0â†’7" ã®ã‚ˆã†ã«æ–‡å­—ã‚„æ•°å­—ãŒæ›¸ã‹ã‚Œã¦ã„ã‚Œã°ã€ãã‚Œã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
   - ã€é‡è¦ã€‘èµ¤ãƒšãƒ³ã®ä¸¸å°ã‚„æ‰‹æ›¸ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã§ã‚‚ã€ãã®**ä¸­ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹æ–‡å­—ã‚„æ•°å­—ï¼ˆä¾‹ï¼šã€Œ0â†’7ã€ãªã©ï¼‰**ã‚’æœ€å„ªå…ˆã§èª­ã¿å–ã£ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚å˜ãªã‚‹ã€Œå‡ºå‹¤ã€ã¨ã—ã¦æ¸ˆã¾ã›ãšã€ä¸­ã®æ–‡å­—ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚
   - ã‚‚ã—æœ¬å½“ã«è¨˜å·ï¼ˆå°é‘‘ã‚„ä¸¸å°ãªã©ï¼‰ã ã‘ã§æ–‡å­—ãŒãªã„å ´åˆã¯ã€ã€Œå‡ºå‹¤ã€ã¨ã—ã¦ãã ã•ã„ã€‚
   - "ä¼‘", "off", "OFF" ã¨ã„ã†æ–‡å­—ãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯ã‚»ãƒ«ãŒã€å®Œå…¨ã«ç©ºæ¬„ï¼ˆç„¡è¡¨è¨˜ï¼‰ã€‘ã®å ´åˆã¯ "ä¼‘ã¿" ã¨ã—ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
4. æŠ½å‡ºå¯¾è±¡å¤–ã®æ’é™¤: æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã¤ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿"ã ã‘"ã‚’æŠ½å‡ºã—ã¾ã™ã€‚ã©ã‚“ãªã«è¡¨ãŒåŸ‹ã¾ã£ã¦ã„ã¦ã‚‚ã€JSONã«ä»–ã®äººã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ãªã„ã§ãã ã•ã„ã€‚

[
  { "date": "2/2", "member": "ã‚µã‚µãƒŸ", "content": "ä¼‘ã¿" },
  { "date": "2/2", "member": "ãƒ„ãƒŠ", "content": "10-19" },
  { "date": "2/3", "member": "ã‚µã‚µãƒŸ", "content": "0â†’7" }
]
`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                {
                                    inlineData: {
                                        mimeType: file.type || 'image/jpeg',
                                        data: base64Image
                                    }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                let resultText = data.candidates[0].content.parts[0].text;

                // Clean up any potential markdown formatting from Gemini
                resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();

                try {
                    const parsedJson = JSON.parse(resultText);

                    // Add mapping data for colors
                    tempParsedData = parsedJson.map(item => {
                        const mconf = memberConfig.find(m => m.name === item.member);
                        return {
                            id: Date.now() + Math.random(),
                            date: item.date,
                            member: item.member,
                            memberColor: mconf ? mconf.color : '#CCC',
                            type: 'shift',
                            content: item.content
                        };
                    });

                    // Show in textarea as fallback text, although we skip analyzeText
                    elInput.value = JSON.stringify(tempParsedData, null, 2);

                    elLoading.classList.add('hidden');
                    renderPreview();
                    toggleSection('preview');

                } catch (jsonErr) {
                    console.error("JSON Parsing Error from Gemini output:", resultText);
                    alert("Geminiã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                    elLoading.classList.add('hidden');
                }

            } catch (err) {
                console.error(err);
                alert("Geminiç”»åƒè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
                elLoading.classList.add('hidden');
            }
        }

        // --- Parsing Logic (Shift + Task) ---
        function analyzeText() {
            const text = elInput.value.trim();
            if (!text) {
                alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const lines = text.split(/\r?\n/);
            tempParsedData = [];
            let currentDate = null;

            const dateRegex = /(\d{1,2})\s*[\/\æœˆ]\s*(\d{1,2})/;

            // ã€æ©Ÿèƒ½è¿½åŠ ã€‘ãƒ†ã‚­ã‚¹ãƒˆã®ä¸Šéƒ¨ã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—ã®ä¸¦ã³é †ï¼‰ã‚’ç‰¹å®šã™ã‚‹
            let detectedHeaders = [];
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                let foundMembers = [];
                memberConfig.forEach(memberData => {
                    const keywords = memberData.keywords.split(',').map(k => k.trim()).filter(k => k);
                    const matchedKeyword = keywords.find(k => lines[i].includes(k));
                    if (matchedKeyword) {
                        foundMembers.push({ member: memberData, pos: lines[i].indexOf(matchedKeyword) });
                    }
                });
                if (foundMembers.length > 0) {
                    foundMembers.sort((a, b) => a.pos - b.pos);
                    detectedHeaders = foundMembers.map(f => f.member);
                    break;
                }
            }

            // ã€æ©Ÿèƒ½è¿½åŠ ã€‘ãƒã‚¤ã‚ºé™¤å»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚·ãƒ•ãƒˆæ™‚é–“ã«é »å‡ºã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿æŠ½å‡ºï¼‰
            const shiftPattern = /(ä¼‘|off|OFF|\d{1,2}[:.ï½ã€œ\-]?\d{1,2}|\d+h?)/g;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // Date Detection
                const dateMatch = trimmed.match(dateRegex);
                let lineDate = null;
                if (dateMatch) {
                    lineDate = `${dateMatch[1]} / ${dateMatch[2]}`;
                    currentDate = lineDate;
                }

                // A) ãƒªã‚¹ãƒˆå½¢å¼ãƒã‚§ãƒƒã‚¯ (åå‰ãŒç›´æ¥å«ã¾ã‚Œã¦ã„ã‚‹ã‹)
                let isShift = false;
                memberConfig.forEach(memberData => {
                    const keywords = memberData.keywords.split(',').map(k => k.trim()).filter(k => k);
                    const matchedKeyword = keywords.find(k => trimmed.includes(k));

                    if (matchedKeyword) {
                        isShift = true;
                        let content = trimmed
                            .replace(matchedKeyword, "")
                            .replace(dateRegex, "")
                            .trim();
                        content = content.replace(/^[:ï¼š,ã€\s]+|[:ï¼š,ã€\s]+$/g, '');

                        if (content.match(/ä¼‘|OFF|off/)) content = "ä¼‘ã¿";

                        tempParsedData.push({
                            id: Date.now() + Math.random(),
                            date: currentDate || "2/1", // fallback
                            member: memberData.name,
                            memberColor: memberData.color,
                            type: 'shift',
                            content: content || "è¦ç¢ºèª"
                        });
                    }
                });

                // B) è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã®æ¨æ¸¬ (åå‰ãŒãªã„ãŒæ—¥ä»˜ãŒã‚ã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç‰¹å®šã§ãã¦ã„ã‚‹å ´åˆ)
                if (!isShift && lineDate && detectedHeaders.length > 0) {
                    let restText = trimmed.replace(dateRegex, "").trim();
                    let tokens = restText.match(shiftPattern);

                    if (tokens && tokens.length > 0) {
                        isShift = true; // ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Œã°ã‚·ãƒ•ãƒˆè¡Œã¨åˆ¤å®š
                        tokens.forEach((token, idx) => {
                            if (idx < detectedHeaders.length) {
                                let content = token;
                                if (content.match(/ä¼‘|OFF|off/)) content = "ä¼‘ã¿";

                                tempParsedData.push({
                                    id: Date.now() + Math.random(),
                                    date: lineDate,
                                    member: detectedHeaders[idx].name,
                                    memberColor: detectedHeaders[idx].color,
                                    type: 'shift',
                                    content: content
                                });
                            }
                        });
                    }
                }

                // C) ã‚¿ã‚¹ã‚¯åˆ¤å®š (ã‚·ãƒ•ãƒˆã§ã¯ãªãæ—¥ä»˜ãŒã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ)
                if (!isShift && lineDate) {
                    let taskName = trimmed.replace(dateRegex, "").trim();
                    taskName = taskName.replace(/^[:ï¼š,ã€\s]+|[:ï¼š,ã€\s]+$/g, '');
                    // ã‚´ãƒŸæ–‡å­—ã ã‘ã®è¡Œã¯é™¤å¤–
                    if (taskName && taskName.replace(/[^\w\sã-ã‚“ã‚¡-ãƒ¶äºœ-ç†™]/g, '').length > 0) {
                        tempParsedData.push({
                            id: Date.now() + Math.random(),
                            date: lineDate,
                            member: "å…¨å“¡/ã€†",
                            memberColor: "#FF7043", // Task color
                            type: 'task',
                            content: "ã€† " + taskName
                        });
                    }
                }
            });

            if (tempParsedData.length === 0) {
                // Fallback for user entering manual row
                tempParsedData.push({
                    id: Date.now(),
                    date: "2/1",
                    member: "ã‚µã‚µãƒŸ",
                    memberColor: "#F48FB1",
                    type: 'shift',
                    content: ""
                });
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å…¥åŠ›ç”¨ã®è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
            }

            renderPreview();
            toggleSection('preview');
        }

        function renderPreview() {
            elPreviewList.innerHTML = '';
            tempParsedData.forEach((item, index) => {
                // Convert M/D to YYYY-MM-DD for input[type=date]
                const ymd = parseDateToInputFormat(item.date);

                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    < div class= "preview-meta" >
                    <input type="date" style="padding:4px;" value="${ymd}" onchange="window.updateTempDate(${index}, this.value)">
                    <span class="preview-member" style="background:${item.memberColor};">${item.member}</span>
                </div>
                <input type="text" value="${item.content}" onchange="window.updateTempContent(${index}, this.value)">
                <button class="preview-delete" onclick="window.removeItem(${index})">Ã—</button>
            `;
                elPreviewList.appendChild(div);
            });
        }

        window.updateTempDate = (index, ymd) => {
            // ymd is 2026-02-20
            if (ymd) {
                const parts = ymd.split('-');
                tempParsedData[index].date = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
            }
        };
        window.updateTempContent = (index, val) => { tempParsedData[index].content = val; };
        window.removeItem = (index) => { tempParsedData.splice(index, 1); renderPreview(); };

        // --- Data Management ---
        function saveData() {
            const newShifts = tempParsedData.map(t => ({
                ...t,
                timestamp: parseDateString(t.date)
            }));

            appData.shifts = [...appData.shifts, ...newShifts];
            appData.shifts.sort((a, b) => a.timestamp - b.timestamp);

            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appData));

            elInput.value = "";
            toggleSection('home');
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_DATA);
                if (raw) {
                    appData = JSON.parse(raw);
                }
            } catch (e) {
                console.error("Data load error", e);
                appData = { shifts: [] };
            }
        }

        function clearData() {
            if (confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY_DATA);
                appData = { shifts: [] };
                renderCalendar();
                renderMatching();
            }
        }

        // Helper: "2/20" -> "2026-02-20"
        function parseDateToInputFormat(str) {
            if (!str) return "2026-02-01";
            const parts = str.split(/[\/\æœˆ]/);
            if (parts.length < 2) return "2026-02-01";
            const m = parts[0].padStart(2, '0');
            const d = parts[1].padStart(2, '0');
            return `2026-${m}-${d}`;
        }

        function parseDateString(str) {
            if (!str) return Date.now();
            const parts = str.split(/[\/\æœˆ]/);
            if (parts.length < 2) return Date.now();
            const m = parseInt(parts[0]);
            const d = parseInt(parts[1]);
            return new Date(2026, m - 1, d).getTime();
        }

        // --- Calendar Rendering ---
        function renderCalendar() {
            elCalendarContainer.innerHTML = '';

            if (!appData.shifts || appData.shifts.length === 0) {
                elCalendarContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: #aaa;">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€Œ+ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
                return;
            }

            const grouped = {};
            appData.shifts.forEach(s => {
                if (!grouped[s.date]) grouped[s.date] = [];
                grouped[s.date].push(s);
            });

            let html = "";
            Object.keys(grouped).forEach(dateStr => {
                const shifts = grouped[dateStr];
                const dateParts = dateStr.split(/[\/\æœˆ]/);

                let barsHtml = "";
                shifts.forEach(s => {
                    if (s.type === 'task') {
                        barsHtml += `
                        <div class="shift-bar task-bar">
                            <span class="shift-name">${s.content}</span>
                        </div>
                    `;
                    } else {
                        const mConf = memberConfig.find(m => m.name === s.member);
                        const color = mConf ? mConf.color : "#eee";
                        barsHtml += `
                        <div class="shift-bar" style="background-color: ${color};">
                            <span class="shift-name">${s.member}</span>
                            <span class="shift-time">${s.content}</span>
                        </div>
                    `;
                    }
                });

                html += `
                <div class="date-row">
                    <div class="date-header">
                        <div class="date-num">${dateParts[1] || dateParts[0]}</div>
                        <div class="date-day">/ ${dateParts[0]}</div> 
                    </div>
                    <div class="shift-bars">
                        ${barsHtml}
                    </div>
                </div>
            `;
            });

            elCalendarContainer.innerHTML = html;
        }

        // --- Matching Logic ---
        function renderMatching() {
            elMatchingList.innerHTML = '';
            if (!appData.shifts || appData.shifts.length === 0) {
                elMatchingList.innerHTML = `<p style="text-align:center; color:#aaa;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
                return;
            }

            const grouped = {};
            appData.shifts.forEach(s => {
                if (s.type === 'shift' && !s.content.includes('ä¼‘')) {
                    if (!grouped[s.date]) grouped[s.date] = new Set();
                    grouped[s.date].add(s.member);
                }
            });

            // Current required members count = 4 (assuming all must work?)
            // Let's filter days where ALL 4 members are working
            const targetCount = memberConfig.length;

            let found = false;
            Object.keys(grouped).forEach(dateStr => {
                const workingMembers = grouped[dateStr];
                if (workingMembers.size >= targetCount) {
                    // Assuming overlap: 13:00-16:00 (Placeholder logic)
                    const div = document.createElement('div');
                    div.className = 'matching-item';
                    div.innerHTML = `
                    <span>${dateStr}</span>
                    <span>ğŸ•’ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°OK</span>
                `;
                    elMatchingList.appendChild(div);
                    found = true;
                }
            });

            if (!found) {
                elMatchingList.innerHTML = `<p style="text-align:center; color:#aaa;">å…¨å“¡ãŒæƒã†æ—¥ã¯ä»Šã®ã¨ã“ã‚ã‚ã‚Šã¾ã›ã‚“...</p>`;
            }
        }

    </script>

</body>

</html>
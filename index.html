<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã—ã¾ã­ã“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ Pro</title>

    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap"
        rel="stylesheet">

    <!-- Removed Tesseract.js for Gemini API Integration -->

    <style>
        :root {
            --color-bg: #FFFAF0;
            /* ãƒ•ãƒ­ãƒ¼ãƒ©ãƒ«ãƒ›ãƒ¯ã‚¤ãƒˆ */
            --color-text: #8D6E63;
            /* ãƒ–ãƒ©ã‚¦ãƒ³ */
            --color-accent: #F4A460;
            /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            --color-accent-hover: #E09050;
            --color-white: #FFFFFF;
            --color-border: #D7CCC8;
            --radius-main: 16px;
            --radius-sm: 8px;
            --shadow-card: 0 4px 12px rgba(141, 110, 99, 0.08);

            /* Default Member Colors */
            --col-sasami: #F48FB1;
            --col-kombu: #A5D6A7;
            --col-tsuna: #90CAF9;
            --col-task: #FF7043;
            /* Task Red */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
            padding-bottom: 80px;
        }

        h1,
        h2,
        h3,
        h4 {
            font-weight: 700;
            color: var(--color-text);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 24px;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Card Style */
        .card {
            background: var(--color-white);
            border-radius: var(--radius-main);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--color-bg);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            background-color: var(--color-text);
            color: var(--color-white);
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            text-align: center;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn:hover {
            background-color: var(--color-accent);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background-color: transparent;
            border: 2px solid var(--color-text);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background-color: var(--color-bg);
            color: var(--color-text);
            border-color: var(--color-accent);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }

        /* Forms */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
        }

        input[type="text"],
        textarea,
        input[type="date"] {
            width: 100%;
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 2px solid var(--color-border);
            background-color: var(--color-bg);
            font-family: inherit;
            font-size: 1rem;
            color: var(--color-text);
            outline: none;
            transition: border-color 0.2s;
        }

        textarea {
            height: 120px;
            resize: vertical;
            margin-bottom: 16px;
        }

        input[type="text"]:focus,
        textarea:focus,
        input[type="date"]:focus {
            border-color: var(--color-accent);
        }

        /* Drop Zone */
        .drop-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-main);
            padding: 24px;
            text-align: center;
            color: var(--color-text);
            background-color: var(--color-bg);
            margin-bottom: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            background-color: #FFF3E0;
            border-color: var(--color-accent);
        }

        /* Member Config Items */
        .member-setting-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-bg);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        /* Preview Table */
        .preview-list {
            list-style: none;
            margin-top: 16px;
        }

        .preview-item {
            background: var(--color-bg);
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 8px;
            align-items: center;
        }

        .preview-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preview-member {
            font-size: 0.8rem;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            text-align: center;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .preview-delete {
            color: #d32f2f;
            cursor: pointer;
            font-size: 1.2rem;
            background: none;
            border: none;
            padding: 8px;
        }

        /* Calendar View (Grid) */
        .calendar-header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 2px solid var(--color-border);
            background: var(--color-white);
            color: var(--color-text);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--color-text);
            color: white;
            border-color: var(--color-text);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .weekday-header {
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #888;
            padding: 8px 0;
        }

        .weekday-header.sun {
            color: #d32f2f;
        }

        .weekday-header.sat {
            color: #1976d2;
        }

        .calendar-day {
            background: var(--color-white);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            min-height: 100px;
            padding: 4px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        /* ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– (ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ç§»è¡Œ) */
        @media (max-width: 600px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }

            .weekday-header {
                display: none;
            }

            .calendar-day {
                min-height: auto;
                padding: 12px;
                gap: 8px;
                flex-direction: row;
                align-items: flex-start;
            }

            .calendar-day .date-header {
                width: 50px;
                flex-shrink: 0;
                text-align: center;
                border-right: 2px solid var(--color-bg);
                margin-right: 8px;
            }

            .calendar-day-content {
                flex: 1;
            }
        }

        .calendar-day.offline {
            background-color: #f5f5f5;
            opacity: 0.8;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0, 0, 0, 0.03) 10px, rgba(0, 0, 0, 0.03) 20px);
        }

        .calendar-day.recommended {
            border: 2px solid #FFD54F;
            background-color: #FFFDE7;
            box-shadow: 0 4px 12px rgba(255, 213, 79, 0.3);
        }

        .calendar-day.collaboration {
            border: 2px solid #E1BEE7;
            background-color: #F3E5F5;
        }

        .date-header {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 4px;
            color: #555;
        }

        .date-header span.badge {
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-left: 4px;
            background: #FFD54F;
            color: #424242;
            vertical-align: top;
        }

        .calendar-day-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .calendar-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .date-row {
            background: var(--color-white);
            border-radius: var(--radius-sm);
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 12px;
        }

        .date-header {
            text-align: center;
            border-right: 2px solid var(--color-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .date-num {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .date-day {
            font-size: 0.8rem;
            color: #888;
        }

        .shift-bars {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .shift-bar {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        .task-bar {
            border-left: 4px solid var(--col-task);
            background: #FFEBEE;
            color: #D84315;
            font-weight: bold;
        }

        .shift-name {
            font-weight: bold;
            margin-right: 8px;
        }

        .shift-time {
            font-size: 0.75rem;
        }

        /* Matching View */
        .matching-item {
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            padding: 12px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            color: #2E7D32;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Bot Interaction Modal */
        .bot-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg);
            border-top: 4px solid var(--col-kombu);
            padding: 24px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 900;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .bot-modal.active {
            transform: translateY(0);
        }

        .bot-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 20px;
        }

        .bot-avatar {
            font-size: 2.5rem;
            background: var(--color-white);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .bot-bubble {
            background: var(--color-white);
            padding: 16px;
            border-radius: 0 16px 16px 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            font-weight: bold;
            flex: 1;
            position: relative;
        }

        .bot-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            left: -10px;
            border-top: 15px solid var(--color-white);
            border-left: 15px solid transparent;
        }

        .bot-content {
            flex: 1;
            overflow-y: auto;
            background: var(--color-white);
            border-radius: var(--radius-sm);
            padding: 16px;
            border: 1px solid var(--color-border);
        }

        .bot-date-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin-top: 16px;
        }

        .bot-date-btn {
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            padding: 12px 4px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
        }

        .bot-date-btn.selected {
            background: var(--col-task);
            color: white;
            border-color: var(--col-task);
        }

        .bot-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 250, 240, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .tab-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px;
            border-radius: 20px;
            border: none;
            background: #EEE;
            cursor: pointer;
            font-weight: bold;
            color: #888;
        }

        .tab-btn.active {
            background: var(--color-accent);
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1 style="cursor: pointer;" onclick="showHome()">ğŸˆ ã—ã¾ã­ã“äºˆå®šè¡¨ Pro</h1>
        </header>

        <section id="home-section">
            <div class="card" style="padding: 16px;">
                <div class="calendar-header-actions">
                    <div class="filter-group">
                        <button class="filter-btn active" onclick="toggleFilter('all')" id="filter-all">å…¨ã¦</button>
                        <button class="filter-btn" onclick="toggleFilter('sasami')" id="filter-sasami">ã‚µã‚µãƒŸ</button>
                        <button class="filter-btn" onclick="toggleFilter('tsuna')" id="filter-tsuna">ãƒ„ãƒŠ</button>
                        <button class="filter-btn" onclick="toggleFilter('kombu')" id="filter-kombu">ã‚³ãƒ³ãƒ–</button>
                        <button class="filter-btn" onclick="toggleFilter('offline')" id="filter-offline">ä¼‘æ¥­æ—¥</button>
                    </div>
                </div>

                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm" onclick="toggleSection('import')">+ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-sm btn-secondary" onclick="toggleSection('settings')">âš™ï¸ è¨­å®š</button>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="clearData()">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <div id="calendar-view">
                <!-- æ›œæ—¥è¦‹å‡ºã— -->
                <div class="calendar-grid" style="margin-bottom: 8px;" id="weekday-header-row">
                    <div class="weekday-header sun">æ—¥</div>
                    <div class="weekday-header">æœˆ</div>
                    <div class="weekday-header">ç«</div>
                    <div class="weekday-header">æ°´</div>
                    <div class="weekday-header">æœ¨</div>
                    <div class="weekday-header">é‡‘</div>
                    <div class="weekday-header sat">åœŸ</div>
                </div>
                <div id="calendar-container" class="calendar-grid"></div>
            </div>

            <div id="calendar-legend"
                style="margin-top: 16px; font-size: 0.8rem; display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                <div><span
                        style="display:inline-block; width:12px; height:12px; background:#FFFDE7; border: 2px solid #FFD54F;"></span>
                    ç¨¼åƒãŠã™ã™ã‚æ—¥</div>
                <div><span
                        style="display:inline-block; width:12px; height:12px; background:#F3E5F5; border: 2px solid #E1BEE7;"></span>
                    3äººå…±é€šäºˆå®šã‚ã‚Š</div>
                <div><span style="display:inline-block; width:12px; height:12px; background:#f5f5f5;"></span> ã—ã¾ã­ã“ä¼‘æ¥­æ—¥
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings-section" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>ãƒ¡ãƒ³ãƒãƒ¼è¨­å®š</h2>
                <button class="btn btn-sm btn-secondary" onclick="saveSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
            </div>

            <div style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px dashed var(--color-border);">
                <div class="member-header">
                    <span>ğŸ¤– Gemini API ã‚­ãƒ¼</span>
                </div>
                <label style="font-size:0.8rem;">ç”»åƒã®é«˜ç²¾åº¦è§£æã«ä½¿ç”¨ã—ã¾ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ä¿å­˜ãƒ»å¤–éƒ¨é€ä¿¡ãªã—ï¼‰</label>
                <input type="password" id="setting-gemini-key" placeholder="AIzaSy... (APIã‚­ãƒ¼ã‚’å…¥åŠ›)">
                <p style="font-size:0.75rem; color:#888; margin-top:4px;">Google AI Studioã§å–å¾—ã—ãŸAPIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <p style="font-size:0.9rem; margin-bottom:16px;">
                ã‚·ãƒ•ãƒˆè¡¨ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹åå‰ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚<br>
                â€»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šã§ãã¾ã™ã€‚
            </p>

            <div id="settings-list"></div>
        </section>

        <!-- Import Section -->
        <section id="import-section" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h2>
                <button class="btn btn-sm btn-secondary" onclick="showHome()">é–‰ã˜ã‚‹</button>
            </div>

            <div class="drop-zone" id="drop-zone">
                <p>ğŸ“· ç”»åƒã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—<br>(ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ)<br><span
                        style="font-size: 0.8rem; color: #aaa;">OCRã§ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿å–ã‚Šã¾ã™</span></p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
            </div>

            <p style="margin-bottom: 8px; font-size: 0.9rem;">ãƒ†ã‚­ã‚¹ãƒˆ (ã‚·ãƒ•ãƒˆè¡¨ ã¾ãŸã¯ Notionã‚¿ã‚¹ã‚¯)</p>
            <textarea id="raw-text-input" placeholder="ä¾‹: 2/20 ç”°ä¸­ 10-19&#10;ä¾‹: 2/25 LPãƒ‡ã‚¶ã‚¤ãƒ³æå‡º"></textarea>
            <button id="btn-analyze" class="btn">è§£æã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        </section>

        <!-- Preview Section -->
        <section id="preview-section" class="card hidden">
            <h2>è§£æçµæœã®ç¢ºèª</h2>
            <p style="margin-bottom: 16px; font-size: 0.9rem;">
                èª­ã¿å–ã‚ŠãƒŸã‚¹ãŒã‚ã‚Œã°æ—¥ä»˜ã‚„å†…å®¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
            </p>

            <div id="preview-list" class="preview-list"></div>

            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button id="btn-cancel" class="btn btn-secondary" onclick="toggleSection('import')">ã‚„ã‚Šç›´ã—</button>
                <button id="btn-save" class="btn" onclick="startBotInteraction()">ã“ã‚Œã§OK (æ¬¡ã¸)</button>
            </div>
        </section>

        <!-- Bot Interaction Modal -->
        <div id="bot-modal" class="bot-modal">
            <div class="bot-header">
                <div class="bot-avatar">ğŸˆâ€â¬›</div>
                <div class="bot-bubble" id="bot-message">
                    OKï¼ã‚·ãƒ•ãƒˆã¯è¦‹è¾¼ã‚ãŸã‚ˆã€‚<br>ã˜ã‚ƒã‚æœ€å¾Œã«ã€ä»Šæœˆã€Œã—ã¾ã­ã“ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚’çµ‚æ—¥ãŠä¼‘ã¿(ã‚ªãƒ•)ã«ã—ãŸã„æ—¥ãŒã‚ã‚Œã°æ•™ãˆã¦ã­ï¼ãƒãƒ¼ãƒ ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‚è€ƒã«ã™ã‚‹ã‚ˆã€‚
                </div>
            </div>
            <div class="bot-content">
                <div style="margin-bottom: 12px; text-align: center;">
                    <label style="font-size:0.85rem; font-weight:bold;">èª°ã®å¸Œæœ›ï¼Ÿ</label>
                    <select id="bot-requester-select"
                        style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; font-family:inherit;">
                        <option value="ã‚µã‚µãƒŸ">ã‚µã‚µãƒŸ</option>
                        <option value="ãƒ„ãƒŠ">ãƒ„ãƒŠ</option>
                        <option value="ã‚³ãƒ³ãƒ–">ã‚³ãƒ³ãƒ–</option>
                        <option value="è‡ªåˆ†ãŸã¡">è‡ªåˆ†ãŸã¡ï¼ˆå…¨å“¡ï¼‰</option>
                    </select>
                </div>
                <p style="font-size:0.8rem; color:#666; text-align:center;">ï¼ˆä¼‘æ¥­æ—¥ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ãŸã„æ—¥ã‚’å…¨ã¦ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼‰</p>
                <div id="bot-calendar-select" class="bot-date-grid">
                    <!-- Date buttons generated by JS -->
                </div>
            </div>
            <div class="bot-actions">
                <button class="btn btn-secondary" onclick="finishBotInteraction(false)">ä¼‘æ¥­æ—¥ãªã—ã§å®Œäº†</button>
                <button class="btn" onclick="finishBotInteraction(true)"
                    style="background:var(--col-kombu); color:var(--color-text);">æ±ºå®šã—ã¦å®Œäº†</button>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay hidden">
            <div style="font-size: 2rem;">ğŸˆ</div>
            <p id="loading-text" style="font-weight: bold; margin-top: 16px;">èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

    </div>

    <script>
        // Global Error Handler
        window.onerror = function (msg, url, line) {
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + msg + "\\nè¡Œ: " + line);
            return false;
        };

        // Config & Data
        const DEFAULT_MEMBERS = [
            { id: "sasami", name: "ã‚µã‚µãƒŸ", color: "#F48FB1", keywords: "ã‚µã‚µãƒŸ,ä½ã€…æœ¨,Sasaki" },
            { id: "kombu", name: "ã‚³ãƒ³ãƒ–", color: "#A5D6A7", keywords: "ã‚³ãƒ³ãƒ–,æ˜†å¸ƒ,ãƒœãƒ–,ç”°ä¸­" },
            { id: "tsuna", name: "ãƒ„ãƒŠ", color: "#90CAF9", keywords: "ãƒ„ãƒŠ,ç¶±,Tsuna,ä½è—¤" }
        ];

        // ç ”ä¿®å¯¾è±¡æ—¥ï¼ˆè‡ªå‹•çš„ã«ã‚³ãƒ³ãƒ–ã®9-13æ™‚ãŒå…¥ã‚‹æ—¥ï¼‰
        // ç ”ä¿®ã¾ã¨ã‚ã‚µã‚¤ãƒˆã®ä»•æ§˜ã«åˆã‚ã›ã€2æœˆã¨3æœˆã®å…¨æ—¥ç¨‹ã‚’å¯¾è±¡ã¨ã™ã‚‹
        const TRAINING_DATES = [];
        for (let i = 1; i <= 28; i++) TRAINING_DATES.push(`2026/02/${String(i).padStart(2, '0')}`);
        for (let i = 1; i <= 31; i++) TRAINING_DATES.push(`2026/03/${String(i).padStart(2, '0')}`);

        const STORAGE_KEY_DATA = "shimaneko_scheduler_data_v4"; // Change key for new data format
        const STORAGE_KEY_CONFIG = "shimaneko_scheduler_config_v1";
        const STORAGE_KEY_API = "shimaneko_scheduler_gemini_key";

        let memberConfig = [];
        let geminiApiKey = "";
        let appData = { shifts: [] };
        let tempParsedData = [];

        let activeFilters = {
            sasami: true, tsuna: true, kombu: true, offline: true
        };
        let botSelectedDates = new Set();
        let currentCalendarMonth = new Date(2026, 1, 1); // 2026å¹´2æœˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        // Valid DOM Elements check
        const elHomeSection = document.getElementById('home-section');
        const elSettingsSection = document.getElementById('settings-section');
        const elImportSection = document.getElementById('import-section');
        const elPreviewSection = document.getElementById('preview-section');

        // View DOMs
        const elCalendarView = document.getElementById('calendar-view');
        const elCalendarContainer = document.getElementById('calendar-container');

        const elInput = document.getElementById('raw-text-input');
        const elPreviewList = document.getElementById('preview-list');

        const elLoading = document.getElementById('loading-overlay');
        const elLoadingText = document.getElementById('loading-text');
        const elDropZone = document.getElementById('drop-zone');
        const elFileInput = document.getElementById('file-input');

        const elBotModal = document.getElementById('bot-modal');
        const elBotCalendarSelect = document.getElementById('bot-calendar-select');

        // Init
        loadConfig();
        loadData();
        renderCalendar();

        // Events
        document.getElementById('btn-analyze').addEventListener('click', analyzeText);

        elDropZone.addEventListener('click', () => elFileInput.click());

        elDropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elDropZone.classList.add('dragover');
        });

        elDropZone.addEventListener('dragleave', () => {
            elDropZone.classList.remove('dragover');
        });

        elDropZone.addEventListener('drop', handleImageDrop);
        elFileInput.addEventListener('change', (e) => handleImageFile(e.target.files[0]));

        // Navigation & Tabs
        function toggleSection(mode) {
            elHomeSection.classList.add('hidden');
            elSettingsSection.classList.add('hidden');
            elImportSection.classList.add('hidden');
            elPreviewSection.classList.add('hidden');
            elLoading.classList.add('hidden');
            elBotModal.classList.remove('active');

            if (mode === 'home') {
                elHomeSection.classList.remove('hidden');
                renderCalendar();
            } else if (mode === 'settings') {
                renderSettings();
                elSettingsSection.classList.remove('hidden');
            } else if (mode === 'import') {
                elImportSection.classList.remove('hidden');
            } else if (mode === 'preview') {
                elPreviewSection.classList.remove('hidden');
            }
        }

        function toggleFilter(key) {
            if (key === 'all') {
                const isActive = document.getElementById('filter-all').classList.contains('active');
                const newVal = !isActive;
                document.getElementById('filter-all').classList.toggle('active', newVal);
                activeFilters.sasami = newVal; activeFilters.tsuna = newVal;
                activeFilters.kombu = newVal; activeFilters.offline = newVal;
                ['sasami', 'tsuna', 'kombu', 'offline'].forEach(k => {
                    document.getElementById('filter-' + k).classList.toggle('active', newVal);
                });
            } else {
                activeFilters[key] = !activeFilters[key];
                document.getElementById('filter-' + key).classList.toggle('active', activeFilters[key]);
                // allãƒœã‚¿ãƒ³ã®åŒæœŸ
                const allActive = activeFilters.sasami && activeFilters.tsuna && activeFilters.kombu && activeFilters.offline;
                document.getElementById('filter-all').classList.toggle('active', allActive);
            }
            renderCalendar();
        }

        window.toggleSection = toggleSection;
        window.showHome = () => toggleSection('home');
        window.clearData = clearData;
        window.saveSettings = saveSettings;
        window.startBotInteraction = startBotInteraction;

        // --- Settings Logic ---
        function loadConfig() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_CONFIG);
                if (raw) {
                    memberConfig = JSON.parse(raw);
                    // Remove mito from existing local storage config
                    memberConfig = memberConfig.filter(m => m.id !== "mito");
                } else {
                    memberConfig = JSON.parse(JSON.stringify(DEFAULT_MEMBERS));
                }

                geminiApiKey = localStorage.getItem(STORAGE_KEY_API) || "";
            } catch (e) {
                console.error("Config load error", e);
                memberConfig = JSON.parse(JSON.stringify(DEFAULT_MEMBERS));
            }
        }

        function renderSettings() {
            const list = document.getElementById('settings-list');
            list.innerHTML = '';

            document.getElementById('setting-gemini-key').value = geminiApiKey;

            memberConfig.forEach((m, idx) => {
                const div = document.createElement('div');
                div.className = 'member-setting-item';
                div.innerHTML = `
                <div class="member-header">
                    <span class="color-dot" style="background:${m.color}"></span>
                    <span>${m.name}</span>
                </div>
                <label style="font-size:0.8rem;">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                <input type="text" id="setting-keywords-${idx}" value="${m.keywords}">
            `;
                list.appendChild(div);
            });
        }

        function saveSettings() {
            memberConfig.forEach((m, idx) => {
                const el = document.getElementById(`setting-keywords-${idx}`);
                if (el) m.keywords = el.value;
            });
            localStorage.setItem(STORAGE_KEY_CONFIG, JSON.stringify(memberConfig));

            geminiApiKey = document.getElementById('setting-gemini-key').value.trim();
            localStorage.setItem(STORAGE_KEY_API, geminiApiKey);

            alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            toggleSection('home');
        }

        // --- Image to Base64 ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data URL prefix
                reader.onerror = error => reject(error);
            });
        }

        // --- OCR Logic ---
        async function handleImageDrop(e) {
            e.preventDefault();
            elDropZone.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleImageFile(e.dataTransfer.files[0]);
            }
        }

        async function handleImageFile(file) {
            if (!file) return;

            if (!geminiApiKey) {
                alert("è¨­å®šç”»é¢ã‹ã‚‰Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ç”»åƒè§£æã«ã¯æœ¬ç‰©ã®AIã‚’åˆ©ç”¨ã—ã¾ã™ã€‚");
                toggleSection('settings');
                return;
            }

            elLoading.classList.remove('hidden');
            elLoadingText.innerText = "Gemini AIãŒç”»åƒã‚’è§£æä¸­...\\n(ã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)";

            try {
                const base64Image = await fileToBase64(file);

                // Construct prompt dynamically with member configurations
                const memberNamesStr = memberConfig.map(m => `ã€Œ${m.name}ã€ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${m.keywords}ï¼‰`).join("ã€");

                const promptText = `
ä»¥ä¸‹ã®ç”»åƒã¯ã‚¹ã‚¿ãƒƒãƒ•ã®å‹¤å‹™ã‚·ãƒ•ãƒˆè¡¨ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ï¼‰ã§ã™ã€‚
è¡¨ã®å½¢å¼ã¯å¤§ããåˆ†ã‘ã¦ä»¥ä¸‹ã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã©ã¡ã‚‰ã‹ã§ã™ã€‚ç”»åƒã‚’è¦‹ã¦å½¢å¼ã‚’è‡ªå‹•ã§åˆ¤åˆ¥ã—ã¦ãã ã•ã„ã€‚
ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Aã€‘åˆ—ï¼ˆç¸¦ï¼‰ãŒã€Œåå‰ã€ã€è¡Œï¼ˆæ¨ªï¼‰ãŒã€Œæ—¥ä»˜ã€ã«ãªã£ã¦ã„ã‚‹è¡¨
ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Bã€‘ä¸€èˆ¬çš„ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å½¢å¼ï¼ˆãƒã‚¹ç›®ã®ä¸­ã«åå‰ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ï¼‰

ã“ã®ä¸­ã‹ã‚‰ã€${memberNamesStr} ã®ã‚·ãƒ•ãƒˆæƒ…å ±ã®ã¿ã‚’æŠ½å‡ºã—ã¦ã€ä»¥ä¸‹ã®JSONé…åˆ—ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ (\`\`\`json) ã¯å«ã‚ãšã€ç›´æ¥JSONãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

ã€è¶…é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
1. å½¢å¼ã®è‡ªå‹•åˆ¤åˆ¥:
   - ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Aã®å ´åˆã€‘ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã«ã‚ã‚‹åå‰ã‚’ç¢ºèªã—ã€æä¾›ã•ã‚ŒãŸã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã«åˆè‡´ã™ã‚‹åå‰ã®åˆ—ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„ã€‚ãã®æ å†…ã®æ–‡å­—ï¼ˆæ™‚é–“ãªã©ï¼‰ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
   - ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Bã®å ´åˆã€‘ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã€Œæ—¥ä»˜ã€ã‚’ç¢ºèªã—ã€ãã®æ—¥ã®ãƒã‚¹ç›®ï¼ˆæ å†…ï¼‰ã«ã€Œã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã«åˆè‡´ã™ã‚‹åå‰ï¼ˆã¾ãŸã¯æ¼¢å­—1æ–‡å­—ãªã©ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°ã€ãã®æ—¥ã¯ã€Œå‡ºå‹¤ã€ã¨ã—ã¦ãã ã•ã„ã€‚åå‰ãŒå«ã¾ã‚Œã¦ã„ãªã„æ—¥ã¯ã€Œä¼‘ã¿ã€ã¨ã—ã¦ãã ã•ã„ã€‚
2. å€¤ã®æŠ½å‡ºãƒ«ãƒ¼ãƒ«:
   - "10-19", "4.5", "11â†’", "0â†’7" ã®ã‚ˆã†ã«æ–‡å­—ã‚„æ•°å­—ãŒæ›¸ã‹ã‚Œã¦ã„ã‚Œã°æœ€å„ªå…ˆã§ãã‚Œã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
   - èµ¤ãƒšãƒ³ã®ä¸¸å°ã‚„æ‰‹æ›¸ãã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã§å›²ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€**ãã®ä¸­ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹æ–‡å­—ã‚„æ•°å­—ï¼ˆä¾‹ï¼šã€Œ0â†’7ã€ãªã©ï¼‰**ã‚’æœ€å„ªå…ˆã§æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚å˜ãªã‚‹ã€Œå‡ºå‹¤ã€ã«ã—ãªã„ã§ãã ã•ã„ã€‚
   - è¨˜å·ï¼ˆå°é‘‘ã‚„ä¸¸å°ãªã©ï¼‰ã ã‘ã§æ–‡å­—ãŒãªã„å ´åˆã€ã¾ãŸã¯ãƒã‚¹ç›®ã«åå‰ã ã‘ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€Œå‡ºå‹¤ã€ã¨ã—ã¦ãã ã•ã„ã€‚
   - "ä¼‘", "off", "OFF" ã¨ã„ã†æ–‡å­—ãŒã‚ã‚‹å ´åˆã€ã¾ãŸã¯å½“è©²ãƒ¡ãƒ³ãƒãƒ¼ã®åå‰ã‚„è¨˜å·ãŒã€å®Œå…¨ã«ãªã„ã€‘å ´åˆã¯ "ä¼‘ã¿" ã¨ã—ã¦æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
3. æŠ½å‡ºå¯¾è±¡å¤–ã®æ’é™¤:
   - æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŒã¤ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿"ã ã‘"ã‚’æŠ½å‡ºã—ã¾ã™ã€‚é–¢ä¿‚ãªã„äººã®ãƒ‡ãƒ¼ã‚¿ã¯çµ¶å¯¾ã«JSONã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚

å‡ºåŠ›ä¾‹:
[
  { "date": "2/2", "member": "ã‚µã‚µãƒŸ", "content": "ä¼‘ã¿" },
  { "date": "2/2", "member": "ãƒ„ãƒŠ", "content": "å‡ºå‹¤" },
  { "date": "2/3", "member": "ã‚µã‚µãƒŸ", "content": "0â†’7" }
]
`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                {
                                    inlineData: {
                                        mimeType: file.type || 'image/jpeg',
                                        data: base64Image
                                    }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API HTTP Error: ${response.status}`);
                }

                const data = await response.json();
                let resultText = data.candidates[0].content.parts[0].text;

                // Clean up any potential markdown formatting from Gemini
                resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();

                try {
                    const parsedJson = JSON.parse(resultText);

                    // Add mapping data for colors
                    tempParsedData = parsedJson.map(item => {
                        const mconf = memberConfig.find(m => m.name === item.member);
                        return {
                            id: Date.now() + Math.random(),
                            date: item.date,
                            member: item.member,
                            memberColor: mconf ? mconf.color : '#CCC',
                            type: 'shift',
                            content: item.content
                        };
                    });

                    // Show in textarea as fallback text, although we skip analyzeText
                    elInput.value = JSON.stringify(tempParsedData, null, 2);

                    elLoading.classList.add('hidden');
                    renderPreview();
                    toggleSection('preview');

                } catch (jsonErr) {
                    console.error("JSON Parsing Error from Gemini output:", resultText);
                    alert("Geminiã‹ã‚‰ã®å¿œç­”å½¢å¼ãŒä¸æ­£ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                    elLoading.classList.add('hidden');
                }

            } catch (err) {
                console.error(err);
                alert("Geminiç”»åƒè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
                elLoading.classList.add('hidden');
            }
        }

        // --- Parsing Logic (Shift + Task) ---
        function analyzeText() {
            const text = elInput.value.trim();
            if (!text) {
                alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const lines = text.split(/\r?\n/);
            tempParsedData = [];
            let currentDate = null;

            const dateRegex = /(\d{1,2})\s*[\/\æœˆ]\s*(\d{1,2})/;

            // ã€æ©Ÿèƒ½è¿½åŠ ã€‘ãƒ†ã‚­ã‚¹ãƒˆã®ä¸Šéƒ¨ã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆåˆ—ã®ä¸¦ã³é †ï¼‰ã‚’ç‰¹å®šã™ã‚‹
            let detectedHeaders = [];
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                let foundMembers = [];
                memberConfig.forEach(memberData => {
                    const keywords = memberData.keywords.split(',').map(k => k.trim()).filter(k => k);
                    const matchedKeyword = keywords.find(k => lines[i].includes(k));
                    if (matchedKeyword) {
                        foundMembers.push({ member: memberData, pos: lines[i].indexOf(matchedKeyword) });
                    }
                });
                if (foundMembers.length > 0) {
                    foundMembers.sort((a, b) => a.pos - b.pos);
                    detectedHeaders = foundMembers.map(f => f.member);
                    break;
                }
            }

            // ã€æ©Ÿèƒ½è¿½åŠ ã€‘ãƒã‚¤ã‚ºé™¤å»ç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆã‚·ãƒ•ãƒˆæ™‚é–“ã«é »å‡ºã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿æŠ½å‡ºï¼‰
            const shiftPattern = /(ä¼‘|off|OFF|\d{1,2}[:.ï½ã€œ\-]?\d{1,2}|\d+h?)/g;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // Date Detection
                const dateMatch = trimmed.match(dateRegex);
                let lineDate = null;
                if (dateMatch) {
                    lineDate = `${dateMatch[1]} / ${dateMatch[2]}`;
                    currentDate = lineDate;
                }

                // A) ãƒªã‚¹ãƒˆå½¢å¼ãƒã‚§ãƒƒã‚¯ (åå‰ãŒç›´æ¥å«ã¾ã‚Œã¦ã„ã‚‹ã‹)
                let isShift = false;
                memberConfig.forEach(memberData => {
                    const keywords = memberData.keywords.split(',').map(k => k.trim()).filter(k => k);
                    const matchedKeyword = keywords.find(k => trimmed.includes(k));

                    if (matchedKeyword) {
                        isShift = true;
                        let content = trimmed
                            .replace(matchedKeyword, "")
                            .replace(dateRegex, "")
                            .trim();
                        content = content.replace(/^[:ï¼š,ã€\s]+|[:ï¼š,ã€\s]+$/g, '');

                        if (content.match(/ä¼‘|OFF|off/)) content = "ä¼‘ã¿";

                        tempParsedData.push({
                            id: Date.now() + Math.random(),
                            date: currentDate || "2/1", // fallback
                            member: memberData.name,
                            memberColor: memberData.color,
                            type: 'shift',
                            content: content || "è¦ç¢ºèª"
                        });
                    }
                });

                // B) è¡¨å½¢å¼ãƒ‡ãƒ¼ã‚¿ã®æ¨æ¸¬ (åå‰ãŒãªã„ãŒæ—¥ä»˜ãŒã‚ã‚Šã€ãƒ˜ãƒƒãƒ€ãƒ¼ãŒç‰¹å®šã§ãã¦ã„ã‚‹å ´åˆ)
                if (!isShift && lineDate && detectedHeaders.length > 0) {
                    let restText = trimmed.replace(dateRegex, "").trim();
                    let tokens = restText.match(shiftPattern);

                    if (tokens && tokens.length > 0) {
                        isShift = true; // ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Œã°ã‚·ãƒ•ãƒˆè¡Œã¨åˆ¤å®š
                        tokens.forEach((token, idx) => {
                            if (idx < detectedHeaders.length) {
                                let content = token;
                                if (content.match(/ä¼‘|OFF|off/)) content = "ä¼‘ã¿";

                                tempParsedData.push({
                                    id: Date.now() + Math.random(),
                                    date: lineDate,
                                    member: detectedHeaders[idx].name,
                                    memberColor: detectedHeaders[idx].color,
                                    type: 'shift',
                                    content: content
                                });
                            }
                        });
                    }
                }

                // C) ã‚¿ã‚¹ã‚¯åˆ¤å®š (ã‚·ãƒ•ãƒˆã§ã¯ãªãæ—¥ä»˜ãŒã‚ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ)
                if (!isShift && lineDate) {
                    let taskName = trimmed.replace(dateRegex, "").trim();
                    taskName = taskName.replace(/^[:ï¼š,ã€\s]+|[:ï¼š,ã€\s]+$/g, '');
                    // ã‚´ãƒŸæ–‡å­—ã ã‘ã®è¡Œã¯é™¤å¤–
                    if (taskName && taskName.replace(/[^\w\sã-ã‚“ã‚¡-ãƒ¶äºœ-ç†™]/g, '').length > 0) {
                        tempParsedData.push({
                            id: Date.now() + Math.random(),
                            date: lineDate,
                            member: "å…¨å“¡/ã€†",
                            memberColor: "#FF7043", // Task color
                            type: 'task',
                            content: "ã€† " + taskName
                        });
                    }
                }
            });

            if (tempParsedData.length === 0) {
                // Fallback for user entering manual row
                tempParsedData.push({
                    id: Date.now(),
                    date: "2/1",
                    member: "ã‚µã‚µãƒŸ",
                    memberColor: "#F48FB1",
                    type: 'shift',
                    content: ""
                });
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å…¥åŠ›ç”¨ã®è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚");
            }

            renderPreview();
            toggleSection('preview');
        }

        function renderPreview() {
            elPreviewList.innerHTML = '';
            tempParsedData.forEach((item, index) => {
                // Convert M/D to YYYY-MM-DD for input[type=date]
                const ymd = parseDateToInputFormat(item.date);

                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    < div class= "preview-meta" >
                    <input type="date" style="padding:4px;" value="${ymd}" onchange="window.updateTempDate(${index}, this.value)">
                    <span class="preview-member" style="background:${item.memberColor};">${item.member}</span>
                </div>
                <input type="text" value="${item.content}" onchange="window.updateTempContent(${index}, this.value)">
                <button class="preview-delete" onclick="window.removeItem(${index})">Ã—</button>
            `;
                elPreviewList.appendChild(div);
            });
        }

        window.updateTempDate = (index, ymd) => {
            // ymd is 2026-02-20
            if (ymd) {
                const parts = ymd.split('-');
                tempParsedData[index].date = `${parseInt(parts[1])}/${parseInt(parts[2])}`;
            }
        };
        window.updateTempContent = (index, val) => { tempParsedData[index].content = val; };
        window.removeItem = (index) => { tempParsedData.splice(index, 1); renderPreview(); };

        // --- Bot Interaction & Data Management ---
        function startBotInteraction() {
            botSelectedDates.clear();
            elBotCalendarSelect.innerHTML = '';

            // æŠ½å‡ºã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¯¾è±¡ã®æœˆã¨æ—¥ä»˜ç¯„å›²ã‚’æŠŠæ¡
            let parsedDates = tempParsedData.map(d => parseDateString(d.date));
            if (parsedDates.length === 0) parsedDates = [Date.now()];

            let targetDateMs = parsedDates.sort((a, b) => a - b)[0];
            let td = new Date(targetDateMs);
            currentCalendarMonth = new Date(td.getFullYear(), td.getMonth(), 1);

            const numDays = new Date(td.getFullYear(), td.getMonth() + 1, 0).getDate();

            for (let i = 1; i <= numDays; i++) {
                const btn = document.createElement('div');
                btn.className = 'bot-date-btn';
                btn.innerText = `${td.getMonth() + 1}/${i}`;
                const dateKey = `${td.getFullYear()}/${td.getMonth() + 1}/${i}`;

                btn.onclick = () => {
                    if (botSelectedDates.has(dateKey)) {
                        botSelectedDates.delete(dateKey);
                        btn.classList.remove('selected');
                    } else {
                        botSelectedDates.add(dateKey);
                        btn.classList.add('selected');
                    }
                };
                elBotCalendarSelect.appendChild(btn);
            }

            elBotModal.classList.add('active');
        }

        function finishBotInteraction(hasOffline) {
            // ä¿å­˜ã™ã‚‹æ–°ã—ã„ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿
            let newShifts = tempParsedData.map(t => {
                let pd = new Date(parseDateString(t.date));
                return {
                    ...t,
                    dateKey: `${pd.getFullYear()}/${pd.getMonth() + 1}/${pd.getDate()}`,
                    timestamp: pd.getTime()
                };
            });

            // ãŠã‚„ã™ã¿å¸Œæœ›æ—¥ã®è¿½åŠ 
            if (hasOffline) {
                const requesterElement = document.getElementById('bot-requester-select');
                const requester = requesterElement ? requesterElement.value : "ã—ã¾ã­ã“ãƒ‡ã‚¶ã‚¤ãƒ³";

                botSelectedDates.forEach(dateKey => {
                    const parts = dateKey.split('/');
                    newShifts.push({
                        id: Date.now() + Math.random(),
                        date: `${parts[1]}/${parts[2]}`,
                        dateKey: dateKey,
                        member: requester,
                        memberColor: "#f5f5f5",
                        type: "team_offline",
                        content: requester === "è‡ªåˆ†ãŸã¡" ? "ä¼‘æ¥­æ—¥" : `${requester}å¸Œæœ›ä¼‘`,
                        timestamp: new Date(parts[0], parts[1] - 1, parts[2]).getTime()
                    });
                });
            }

            appData.shifts = [...appData.shifts, ...newShifts];

            // ç ”ä¿®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è‡ªå‹•åæ˜ 
            appData.shifts = applyTrainingSchedules(appData.shifts);

            appData.shifts.sort((a, b) => a.timestamp - b.timestamp);
            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(appData));

            elInput.value = "";
            elBotModal.classList.remove('active');
            toggleSection('home');
        }

        function applyTrainingSchedules(currentShifts) {
            // ã‚³ãƒ³ãƒ–ã®ç ”ä¿®æ—¥ã‚’è‡ªå‹•æŒ¿å…¥ã€‚æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯é‡è¤‡ã•ã›ãªã„ã€‚
            const newShifts = [...currentShifts];
            TRAINING_DATES.forEach(td => {
                const parts = td.split('/');
                const y = parseInt(parts[0]);
                const m = parseInt(parts[1]);
                const d = parseInt(parts[2]);

                const dateKey = `${y}/${m}/${d}`;
                const exists = newShifts.find(s => s.member === "ã‚³ãƒ³ãƒ–" && s.dateKey === dateKey && s.content.includes('ç ”ä¿®'));

                if (!exists) {
                    newShifts.push({
                        id: Date.now() + Math.random(),
                        date: `${m}/${d}`,
                        dateKey: dateKey,
                        member: "ã‚³ãƒ³ãƒ–",
                        memberColor: "#A5D6A7",
                        type: "shift",
                        content: "9-13(ç ”ä¿®)",
                        timestamp: new Date(y, m - 1, d).getTime(),
                        isAuto: true
                    });
                }
            });
            return newShifts;
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY_DATA);
                if (raw) {
                    appData = JSON.parse(raw);
                } else {
                    appData = { shifts: [] };
                }
            } catch (e) {
                console.error("Data load error", e);
                appData = { shifts: [] };
            }
        }

        function clearData() {
            if (confirm("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY_DATA);
                appData = { shifts: [] };
                renderCalendar();
            }
        }

        // Helper: "2/20" -> "2026-02-20"
        function parseDateToInputFormat(str) {
            if (!str) return "2026-02-01";
            const parts = str.split(/[\/\æœˆ]/);
            if (parts.length < 2) return "2026-02-01";
            const m = parts[0].padStart(2, '0');
            const d = parts[1].padStart(2, '0');
            return `2026-${m}-${d}`;
        }

        function parseDateString(str) {
            if (!str) return Date.now();
            const parts = str.split(/[\/\æœˆ]/);
            if (parts.length < 2) return Date.now();
            const m = parseInt(parts[0]);
            const d = parseInt(parts[1]);
            return new Date(2026, m - 1, d).getTime();
        }

        // --- New Full Grid Calendar Rendering ---
        function changeMonth(offset) {
            currentCalendarMonth = new Date(currentCalendarMonth.getFullYear(), currentCalendarMonth.getMonth() + offset, 1);
            renderCalendar();
        }

        function renderCalendar() {
            elCalendarContainer.innerHTML = '';

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            const firstDay = new Date(year, month, 1).getDay(); // 0(Sun) - 6(Sat)
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Header for Month
            const monthHeader = document.getElementById('calendar-month-title');
            if (monthHeader) {
                monthHeader.innerText = `${year}å¹´ ${month + 1}æœˆ`;
            } else {
                const headerDiv = document.createElement('div');
                headerDiv.style = "display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;";
                headerDiv.innerHTML = `
                    <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">ï¼œ å…ˆæœˆ</button>
                    <h2 id="calendar-month-title" style="margin:0;">${year}å¹´ ${month + 1}æœˆ</h2>
                    <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)">ç¿Œæœˆ ï¼</button>
                `;
                elCalendarView.insertBefore(headerDiv, elCalendarView.firstChild);
            }

            // ãƒ‡ãƒ¼ã‚¿ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ– (dateKeyå˜ä½ã¸)
            const grouped = {};
            appData.shifts.forEach(s => {
                if (!s.dateKey) {
                    // å¤ã„ãƒ‡ãƒ¼ã‚¿ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const pd = new Date(s.timestamp || parseDateString(s.date));
                    s.dateKey = `${pd.getFullYear()}/${pd.getMonth() + 1}/${pd.getDate()}`;
                }
                if (!grouped[s.dateKey]) grouped[s.dateKey] = [];
                grouped[s.dateKey].push(s);
            });

            // å‰æœˆã®ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day';
                emptyCell.style.opacity = '0.3';
                elCalendarContainer.appendChild(emptyCell);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}/${month + 1}/${d}`;
                const dailyData = grouped[dateKey] || [];

                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                // ç¨¼åƒã‚„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ†æ
                let hasTeamOffline = false;
                let activeWorkers = 0;
                let filteredBars = "";

                dailyData.forEach(s => {
                    let shouldShow = false;

                    if (s.type === 'team_offline') {
                        hasTeamOffline = true;
                        if (activeFilters.offline) shouldShow = true;
                    }
                    else if (s.type === 'shift') {
                        if (s.content !== "ä¼‘ã¿" && !s.content.match(/ä¼‘|off|OFF/)) {
                            activeWorkers++;
                        }

                        const mConf = memberConfig.find(m => m.name === s.member);
                        if (mConf) {
                            if (mConf.id === 'sasami' && activeFilters.sasami) shouldShow = true;
                            if (mConf.id === 'tsuna' && activeFilters.tsuna) shouldShow = true;
                            if (mConf.id === 'kombu' && activeFilters.kombu) shouldShow = true;
                        } else if (activeFilters.all || activeFilters.offline) {
                            shouldShow = true; // Other tasks/unknown
                        }
                    } else {
                        shouldShow = true; // Task shown always if there
                    }

                    if (shouldShow) {
                        const color = s.memberColor || "#eee";

                        if (s.type === 'team_offline') {
                            filteredBars += `
                                <div class="shift-item" style="background: repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 5px, #e8e8e8 5px, #e8e8e8 10px); border: 1px solid #ccc; color: #555; padding: 4px; border-radius: 4px; font-size: 0.75rem; text-align: center; margin-top:2px; font-weight:bold;">
                                    <span>${s.content}</span>
                                </div>
                            `;
                        } else if (s.type === 'task') {
                            filteredBars += `
                                <div class="shift-item task-bar" style="border-left:3px solid ${color}; background:#fff; padding: 2px 4px; margin-top: 2px; border-radius: 2px; font-size:0.75rem;">
                                    <span class="shift-name">${s.content}</span>
                                </div>
                            `;
                        } else {
                            const isOff = s.content && !!s.content.match(/ä¼‘|off|OFF/);
                            if (isOff) {
                                filteredBars += `
                                    <div class="shift-item" style="background-color: #f8f9fa; color: #aaa; border-left: 3px solid #ccc; padding: 2px 4px; margin-top: 2px; border-radius: 2px; font-size: 0.75rem; display: flex; justify-content: space-between;">
                                        <span class="shift-name">${s.member}</span>
                                        <span class="shift-time" style="text-decoration: line-through;">${s.content}</span>
                                    </div>
                                `;
                            } else {
                                filteredBars += `
                                    <div class="shift-item" style="background-color: ${color}20; color: #333; border-left: 4px solid ${color}; padding: 3px 6px; margin-top: 3px; border-radius: 3px; font-size: 0.8rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-weight:bold;">
                                        <span class="shift-name">${s.member}</span>
                                        <span class="shift-time" style="background: #fff; padding: 1px 4px; border-radius: 4px;">${s.content}</span>
                                    </div>
                                `;
                            }
                        }
                    }
                });

                // è¡Œå‹•è§£æ (ã‚¯ãƒ©ã‚¹ä»˜ä¸)
                let badgeHtml = "";
                if (hasTeamOffline) {
                    cell.classList.add('offline');
                } else if (activeWorkers === 3) {
                    cell.classList.add('collaboration');
                    badgeHtml = `<span class="badge">3äººæ—¥</span>`;
                } else if (activeWorkers === 0 && dailyData.length > 0) {
                    // å…¨å“¡ä¼‘ã¿ã®å ´åˆç¨¼åƒãŠã‚¹ã‚¹ãƒ¡ï¼Ÿ User requested: "å…¨å“¡ãŒå‹•ã‘ã‚‹æ—¥ã ã‘... ä¸‰äººãŒå‹•ãã‚„ã™ã„æ—¥ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦"
                    // ãŠãã‚‰ãã€Œã‚·ãƒ•ãƒˆãŒå…¥ã£ã¦ã„ãªã„ï¼†ãƒãƒ¼ãƒ ã‚ªãƒ•ãŒãªã„ï¼å…¨å“¡å‹•ã‘ã‚‹ã€ã¨ã„ã†è§£é‡ˆã€‚
                    // é€†ã«ã€ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚‹ã‘ã©3äººã¨ã‚‚ã‚·ãƒ•ãƒˆã§"ä¼‘ã¿"ã®å ´åˆã‚’ç¨¼åƒå¯èƒ½æ—¥ã¨ã™ã‚‹ï¼ˆåˆ¥ã®æ¥­å‹™ã«å›ã‚Œã‚‹ï¼‰
                    // ã²ã¨ã¾ãšã€3äººä¼‘ã¿ã®æ—¥ã‚’ Recommended ã«ã™ã‚‹ã€‚
                    cell.classList.add('recommended');
                    badgeHtml = `<span class="badge" style="background:#81C784; color:white;">ä½œæ¥­ãŠã‚¹ã‚¹ãƒ¡âœ¨</span>`;
                }

                cell.innerHTML = `
                    <div class="date-header">${d} ${badgeHtml}</div>
                    <div class="calendar-day-content">${filteredBars}</div>
                `;
                elCalendarContainer.appendChild(cell);
            }
        }
    </script>

</body>

</html>